<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Order Details - Building Materials</title>
  <style>
    :root { --accent: #2d9cdb; --success: #2e7d32; --muted: #666; }
    body { 
      font-family: Arial, Helvetica, sans-serif; 
      margin: 20px; 
      color: #222; 
      background: #f7f9fb;
    }
    .container { 
      max-width: 900px; 
      margin: 0 auto; 
    }
    .header {
      background: #e8f5e9;
      border-left: 4px solid var(--success);
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .header h1 { 
      margin: 0 0 10px 0; 
      color: var(--success);
    }
    .header .order-id { 
      font-size: 18px; 
      font-weight: bold; 
      color: var(--success);
    }
    .header .status { 
      display: inline-block;
      background: var(--success);
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      margin-top: 10px;
    }
    .card {
      background: #fff;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
      margin-bottom: 20px;
    }
    .card h2 { 
      margin: 0 0 15px 0; 
      color: #333; 
      border-bottom: 2px solid var(--accent);
      padding-bottom: 10px;
    }
    .info-row {
      display: grid;
      grid-template-columns: 150px 1fr;
      gap: 20px;
      margin-bottom: 12px;
      padding: 10px 0;
      border-bottom: 1px solid #eee;
    }
    .info-row:last-child {
      border-bottom: none;
    }
    .info-label {
      font-weight: 600;
      color: var(--muted);
    }
    .info-value {
      color: #222;
      word-break: break-word;
    }
    .items-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    .items-table th {
      background: #f5f5f5;
      padding: 10px;
      text-align: left;
      font-weight: 600;
      border-bottom: 2px solid var(--accent);
    }
    .items-table td {
      padding: 12px 10px;
      border-bottom: 1px solid #eee;
    }
    .items-table tr:last-child td {
      border-bottom: none;
    }
    .item-image {
      width: 50px;
      height: 50px;
      object-fit: cover;
      border-radius: 4px;
    }
    .item-name {
      font-weight: 600;
      color: #333;
    }
    .summary {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 2px solid #eee;
    }
    .summary-row {
      display: flex;
      justify-content: space-between;
      font-size: 16px;
    }
    .summary-row.total {
      font-weight: 700;
      font-size: 18px;
      color: var(--success);
    }
    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      flex-wrap: wrap;
    }
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      text-decoration: none;
      display: inline-block;
    }
    .btn-primary {
      background: var(--accent);
      color: white;
    }
    .btn-primary:hover {
      background: #1a7aa8;
    }
    .btn-secondary {
      background: #eee;
      color: #333;
    }
    .btn-secondary:hover {
      background: #ddd;
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: var(--accent);
    }
    .error {
      background: #ffebee;
      color: #c62828;
      padding: 15px;
      border-radius: 6px;
      border-left: 4px solid #c62828;
      margin-bottom: 20px;
    }
    .success-message {
      background: #e8f5e9;
      color: var(--success);
      padding: 15px;
      border-radius: 6px;
      border-left: 4px solid var(--success);
      margin-bottom: 20px;
    }
    .orders-list {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    .order-card {
      background: #fff;
      border-radius: 8px;
      padding: 18px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
      border-left: 4px solid var(--accent);
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .order-card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      transform: translateX(4px);
    }
    .order-info {
      flex: 1;
    }
    .order-info-row {
      display: flex;
      gap: 20px;
      margin-bottom: 8px;
    }
    .order-info-item {
      font-size: 14px;
    }
    .order-info-label {
      font-weight: 600;
      color: var(--muted);
    }
    .order-price {
      font-weight: 700;
      color: var(--success);
      font-size: 18px;
      margin-right: 20px;
    }
    .empty-state {
      text-align: center;
      padding: 40px;
      color: var(--muted);
    }
    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 20px;
    }
    @media(max-width:600px) {
      .info-row {
        grid-template-columns: 1fr;
      }
      .items-table {
        font-size: 12px;
      }
      .items-table th,
      .items-table td {
        padding: 8px 5px;
      }
      .button-group {
        flex-direction: column;
      }
      .btn {
        width: 100%;
        text-align: center;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <a href="http://localhost:5000/index.html" style="color: var(--accent); text-decoration: none; margin-bottom: 20px; display: inline-block;">‚Üê Back to Home</a>
    
    <div id="content">
      <div class="loading">
        <div style="font-size: 18px;">‚è≥ Loading order details...</div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = 'http://localhost:5000/api';
    
    function formatPrice(v) { 
      return '‚Çπ' + Number(v || 0).toFixed(2); 
    }
    
    function escapeHtml(s) { 
      return String(s).replace(/[&<>"\']/g, c => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
      }[c])); 
    }
    
    async function loadOrderDetails() {
      const contentEl = document.getElementById('content');
      
      try {
        // Get order ID from URL parameter
        const urlParams = new URLSearchParams(location.search);
        const orderId = urlParams.get('id') || urlParams.get('orderId');
        
        // If order ID provided, show specific order
        if (orderId && orderId !== '' && !orderId.includes('-')) {
          console.log('');
          console.log('üîç Fetching order details for ID:', orderId);
          
          // Fetch order details from backend
          const endpoint = API_BASE + '/order/' + encodeURIComponent(orderId);
          console.log('üì° API Endpoint:', endpoint);
          
          const res = await fetch(endpoint, {
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' }
          });
          
          console.log('üìä Response status:', res.status);
          
          if (!res.ok) {
            const errorText = await res.text();
            console.error('‚ùå Server error:', errorText);
            throw new Error('Failed to fetch order (status: ' + res.status + ')');
          }
          
          const data = await res.json();
          console.log('‚úÖ Order data received:', data);
          
          if (!data.success || !data.order) {
            contentEl.innerHTML = '<div class="error">‚ùå ' + escapeHtml(data.error || 'Order not found') + '</div>';
            return;
          }
          
          const order = data.order;
          const items = data.items || [];
          
          console.log('üì¶ Number of items in order:', items.length);
          items.forEach((item, idx) => {
            console.log(`  Item ${idx + 1}: ${item.name} | Qty: ${item.qty} | Price: ‚Çπ${item.price}`);
          });
          
          // Build HTML for single order
          let html = `
            <div class="header">
              <h1>‚úì Order Confirmed</h1>
              <div class="order-id">Order ID: #${escapeHtml(order.id)}</div>
              <div class="status">${escapeHtml(order.status || 'PENDING').toUpperCase()}</div>
            </div>
            
            <div class="success-message">
              Thank you for your order! We will process it shortly. You will receive an email confirmation at <strong>${escapeHtml(order.email)}</strong>
            </div>
            
            <div class="card">
              <h2>Shipping Details</h2>
              <div class="info-row">
                <div class="info-label">Name</div>
                <div class="info-value">${escapeHtml(order.customer_name)}</div>
              </div>
              <div class="info-row">
                <div class="info-label">Email</div>
                <div class="info-value">${escapeHtml(order.email)}</div>
              </div>
              <div class="info-row">
                <div class="info-label">Address</div>
                <div class="info-value" style="white-space: pre-wrap;">${escapeHtml(order.address)}</div>
              </div>
              <div class="info-row">
                <div class="info-label">Order Date</div>
                <div class="info-value">${new Date(order.created_at).toLocaleString()}</div>
              </div>
            </div>
            
            <div class="card">
              <h2>Order Items</h2>
              <table class="items-table">
                <thead>
                  <tr>
                    <th>Product Name</th>
                    <th>Quantity</th>
                    <th>Price</th>
                    <th>Total</th>
                  </tr>
                </thead>
                <tbody>
          `;
          
          let subtotal = 0;
          items.forEach(item => {
            const itemTotal = Number(item.price) * Number(item.qty);
            subtotal += itemTotal;
            html += `
              <tr>
                <td>
                  <div style="display: flex; align-items: center; gap: 10px;">
                    <img src="${item.image || 'Images/image.png'}" alt="${escapeHtml(item.name)}" class="item-image" onerror="this.src='Images/image.png'">
                    <span class="item-name">${escapeHtml(item.name)}</span>
                  </div>
                </td>
                <td>${item.qty}</td>
                <td>${formatPrice(item.price)}</td>
                <td>${formatPrice(itemTotal)}</td>
              </tr>
            `;
          });
          
          const shipping = 0;
          const tax = 0;
          const total = subtotal + shipping + tax;
          
          html += `
                </tbody>
              </table>
              
              <div class="summary">
                <div class="summary-row">
                  <span>Subtotal</span>
                  <span>${formatPrice(subtotal)}</span>
                </div>
                <div class="summary-row">
                  <span>Shipping</span>
                  <span>${formatPrice(shipping)}</span>
                </div>
                <div class="summary-row">
                  <span>Tax</span>
                  <span>${formatPrice(tax)}</span>
                </div>
                <div class="summary-row total">
                  <span>Total Amount</span>
                  <span>${formatPrice(total)}</span>
                </div>
              </div>
            </div>
            
            <div class="button-group">
              <a href="http://localhost:5000/order-details.html" class="btn btn-secondary">‚Üê View All Orders</a>
              <a href="http://localhost:5000/index.html" class="btn btn-primary">Continue Shopping</a>
              <button class="btn btn-secondary" onclick="window.print()">üñ® Print Receipt</button>
            </div>
          `;
          
          contentEl.innerHTML = html;
          sessionStorage.removeItem('lastOrderId');
          return;
        }
        
        // Otherwise, show all orders
        await loadOrderHistory();
        
      } catch (err) {
        console.error('‚ùå Error loading order:', err);
        contentEl.innerHTML = '<div class="error">‚ùå Failed to load order details: ' + escapeHtml(err.message) + '</div>';
      }
    }
    
    async function loadOrderHistory() {
      const contentEl = document.getElementById('content');
      
      try {
        console.log('');
        console.log('üìã Loading all orders with product details...');
        
        // Fetch all orders with products
        const allOrdersRes = await fetch(API_BASE + '/all-orders', {
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' }
        });
        
        if (!allOrdersRes.ok) {
          throw new Error('Failed to fetch orders (status: ' + allOrdersRes.status + ')');
        }
        
        const allOrdersData = await allOrdersRes.json();
        console.log('‚úÖ Orders data received:', allOrdersData);
        
        if (!allOrdersData.success || !allOrdersData.orders) {
          contentEl.innerHTML = '<div class="error">‚ùå ' + escapeHtml(allOrdersData.error || 'Failed to load orders') + '</div>';
          return;
        }
        
        const orders = allOrdersData.orders;
        console.log('üì¶ Total orders loaded:', orders.length);
        
        if (orders.length === 0) {
          let html = `
            <div class="card">
              <div class="empty-state">
                <div class="empty-state-icon">üì¶</div>
                <h2 style="color: #333; margin: 0 0 10px 0;">No Orders Yet</h2>
                <p style="margin: 10px 0;">No orders have been placed yet.</p>
                <a href="http://localhost:5000/index.html" class="btn btn-primary" style="display: inline-block; margin-top: 20px;">Browse Products</a>
              </div>
            </div>
          `;
          contentEl.innerHTML = html;
          return;
        }
        
        let html = `
          <div class="header">
            <h1>üìã All Orders</h1>
            <p style="margin: 10px 0 0 0; color: var(--success);">Total orders: ${orders.length}</p>
          </div>
          
          <div class="card">
            <table class="items-table" style="width: 100%;">
              <thead>
                <tr>
                  <th>Order ID</th>
                  <th>Customer</th>
                  <th>Product Names / IDs</th>
                  <th>Total</th>
                  <th>Date</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
        `;
        
        orders.forEach(order => {
          const orderDate = new Date(order.created_at).toLocaleDateString('en-IN', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
          });
          
          // Get product names and IDs
          const productInfo = order.items && order.items.length > 0 
            ? order.items.map(item => `${escapeHtml(item.name)} (ID: ${item.product_id})`).join(', ')
            : 'No items';
          
          console.log(`Order ${order.id}: ${productInfo}`);
          
          html += `
            <tr>
              <td style="font-weight: 600; color: var(--accent);">#${order.id}</td>
              <td>${escapeHtml(order.customer_name)}</td>
              <td>${productInfo}</td>
              <td style="font-weight: 600; color: var(--success);">‚Çπ${Number(order.total).toFixed(2)}</td>
              <td>${orderDate}</td>
              <td>
                <button class="btn btn-primary" onclick="viewOrder(${order.id})" style="padding: 6px 12px; font-size: 12px;">View</button>
              </td>
            </tr>
          `;
        });
        
        html += `
              </tbody>
            </table>
          </div>
          
          <div style="margin-top: 20px; padding: 15px; background: #f5f5f5; border-radius: 6px; text-align: center;">
            <p style="margin: 0; color: var(--muted); font-size: 13px;">Showing last 50 orders</p>
          </div>
          
          <div class="button-group">
            <a href="http://localhost:5000/index.html" class="btn btn-primary">Continue Shopping</a>
          </div>
        `;
        
        contentEl.innerHTML = html;
        
      } catch (err) {
        console.error('‚ùå Error loading orders:', err);
        contentEl.innerHTML = '<div class="error">‚ùå Failed to load orders: ' + escapeHtml(err.message) + '</div>';
      }
    }
    
    function searchOrder() {
      const orderId = document.getElementById('orderIdInput').value.trim();
      if (!orderId) {
        alert('Please enter an Order ID');
        return;
      }
      location.href = '?id=' + encodeURIComponent(orderId);
    }
    
    function viewOrder(orderId) {
      location.href = '?id=' + orderId;
    }
    
    // Load on page load
    document.addEventListener('DOMContentLoaded', () => {
      console.log('');
      console.log('=== Order Details Page Loaded ===');
      loadOrderDetails();
    });
  </script>
</body>
</html>
